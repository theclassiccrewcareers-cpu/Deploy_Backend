<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClassBridge Connection Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .url-display {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            word-break: break-all;
        }

        .url-label {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .results {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            display: none;
        }

        .results.show {
            display: block;
        }

        .results.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .results.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .results.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .result-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .result-details {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-badge.online {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.offline {
            background: #f8d7da;
            color: #721c24;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .test-grid button {
            margin-bottom: 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ðŸ”§ ClassBridge Connection Tester</h1>
        <p class="subtitle">Test the connection between your frontend and backend deployments</p>

        <div class="url-display">
            <div class="url-label">Frontend (Vercel):</div>
            <div id="frontend-url">https://ed-tech-portal.vercel.app</div>
        </div>

        <div class="url-display">
            <div class="url-label">Backend (Render):</div>
            <div id="backend-url">https://nexuxbackend.onrender.com</div>
        </div>

        <div class="test-grid">
            <button onclick="testHealth()">Test Health</button>
            <button onclick="testCORS()">Test CORS</button>
            <button onclick="testAPI()">Test API</button>
            <button onclick="runAllTests()">Run All Tests</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>Testing connection...</div>
        </div>

        <div class="results" id="results"></div>
    </div>

    <script>
        const BACKEND_URL = 'https://classbridge-backend-bqj3.onrender.com';
        const FRONTEND_URL = 'https://ed-tech-portal.vercel.app';

        function showLoading() {
            document.getElementById('loading').classList.add('show');
            document.getElementById('results').classList.remove('show');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }

        function showResult(type, title, message, details = null) {
            hideLoading();
            const resultsDiv = document.getElementById('results');
            resultsDiv.className = `results show ${type}`;

            let html = `<div class="result-title">${title}</div><div>${message}</div>`;
            if (details) {
                html += `<div class="result-details">${details}</div>`;
            }
            resultsDiv.innerHTML = html;
        }

        async function testHealth() {
            showLoading();
            try {
                const response = await fetch(`${BACKEND_URL}/api/health`, {
                    method: 'GET',
                    headers: {
                        'Origin': FRONTEND_URL
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const details = JSON.stringify(data, null, 2);
                    showResult('success', 'âœ… Backend is Healthy!',
                        `The backend is running and responding correctly.`, details);
                } else {
                    showResult('error', 'âŒ Backend Error',
                        `Backend returned status code: ${response.status}`);
                }
            } catch (error) {
                showResult('error', 'âŒ Connection Failed',
                    `Cannot connect to backend. It might be sleeping (free tier) or not deployed.`,
                    `Error: ${error.message}\n\nTry again in 30 seconds if the service was sleeping.`);
            }
        }

        async function testCORS() {
            showLoading();
            try {
                const response = await fetch(`${BACKEND_URL}/api/health`, {
                    method: 'GET',
                    headers: {
                        'Origin': FRONTEND_URL
                    }
                });

                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Credentials': response.headers.get('Access-Control-Allow-Credentials'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
                };

                const allowedOrigin = corsHeaders['Access-Control-Allow-Origin'];

                if (allowedOrigin && (allowedOrigin === FRONTEND_URL || allowedOrigin === '*')) {
                    showResult('success', 'âœ… CORS Configured Correctly!',
                        `The backend allows requests from the frontend.`,
                        `CORS Headers:\n${JSON.stringify(corsHeaders, null, 2)}`);
                } else {
                    showResult('warning', 'âš ï¸ CORS May Have Issues',
                        `CORS headers present but origin might not match.`,
                        `Expected Origin: ${FRONTEND_URL}\nAllowed Origin: ${allowedOrigin}\n\nFull Headers:\n${JSON.stringify(corsHeaders, null, 2)}`);
                }
            } catch (error) {
                showResult('error', 'âŒ CORS Test Failed',
                    `Cannot test CORS - backend is not responding.`,
                    `Error: ${error.message}`);
            }
        }

        async function testAPI() {
            showLoading();
            try {
                const response = await fetch(`${BACKEND_URL}/api/admin/schools`, {
                    method: 'GET',
                    headers: {
                        'Origin': FRONTEND_URL,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult('success', 'âœ… API is Working!',
                        `Successfully called API endpoint.`,
                        `Response:\n${JSON.stringify(data, null, 2)}`);
                } else {
                    const text = await response.text();
                    showResult('warning', 'âš ï¸ API Responded with Error',
                        `API is reachable but returned an error.`,
                        `Status: ${response.status}\nResponse:\n${text}`);
                }
            } catch (error) {
                showResult('error', 'âŒ API Test Failed',
                    `Cannot connect to API endpoint.`,
                    `Error: ${error.message}`);
            }
        }

        async function runAllTests() {
            showLoading();

            const results = {
                health: null,
                cors: null,
                api: null
            };

            // Test Health
            try {
                const response = await fetch(`${BACKEND_URL}/api/health`);
                results.health = response.ok ? 'âœ… PASS' : 'âŒ FAIL';
            } catch (error) {
                results.health = 'âŒ FAIL (Timeout)';
            }

            // Test CORS
            try {
                const response = await fetch(`${BACKEND_URL}/api/health`, {
                    headers: { 'Origin': FRONTEND_URL }
                });
                const allowedOrigin = response.headers.get('Access-Control-Allow-Origin');
                results.cors = (allowedOrigin === FRONTEND_URL || allowedOrigin === '*') ? 'âœ… PASS' : 'âš ï¸ WARNING';
            } catch (error) {
                results.cors = 'âŒ FAIL';
            }

            // Test API
            try {
                const response = await fetch(`${BACKEND_URL}/api/admin/schools`);
                results.api = response.ok ? 'âœ… PASS' : 'âš ï¸ WARNING';
            } catch (error) {
                results.api = 'âŒ FAIL';
            }

            const allPassed = Object.values(results).every(r => r.startsWith('âœ…'));
            const type = allPassed ? 'success' : 'warning';

            showResult(type, allPassed ? 'âœ… All Tests Passed!' : 'âš ï¸ Some Tests Failed',
                'Test results summary:',
                `Health Check: ${results.health}\nCORS Configuration: ${results.cors}\nAPI Endpoint: ${results.api}\n\n${allPassed ? 'Your deployment is working correctly!' : 'Check the individual tests for more details.'}`);
        }

        // Auto-run health check on load
        window.addEventListener('load', () => {
            setTimeout(testHealth, 500);
        });
    </script>
</body>

</html>